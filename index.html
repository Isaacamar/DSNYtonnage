<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>Borough Blocks — NYC Material Tonnage</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root {
    --bg: #f7f7f7;
    --ink: #111;
    --muted: #6b7280;
    --border: #e5e7eb;
    --focus: #3b82f6;
  }
  
  * { box-sizing: border-box; }
  
  body {
    margin: 0;
    padding: 24px;
    background: var(--bg);
    color: var(--ink);
    font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }
  
  #app {
    max-width: 1600px;
    margin: 0 auto;
  }
  
  header {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
    margin-bottom: 20px;
    padding: 16px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  
  .title {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
  }
  
  .controls {
    display: flex;
    gap: 12px;
    align-items: center;
    flex: 1;
    flex-wrap: wrap;
  }
  
  .slider-container {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    min-width: 200px;
  }
  
  input[type="range"] {
    flex: 1;
    min-width: 120px;
  }
  
  .month-label {
    font-weight: 600;
    min-width: 80px;
    text-align: right;
    font-variant-numeric: tabular-nums;
  }
  
  button {
    padding: 6px 12px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    font: inherit;
    transition: all 0.2s;
  }
  
  button:hover {
    background: #f9fafb;
    border-color: var(--muted);
  }
  
  label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    user-select: none;
  }
  
  .main-container {
    display: flex;
    gap: 20px;
    align-items: flex-start;
    transition: transform 0.3s ease;
  }
  
  .main-container.panel-open {
    transform: translateX(-0px);
  }
  
  #viz-container {
    flex: 0 0 1100px;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  
  .info-banner {
    background: #dbeafe;
    border: 2px solid #3b82f6;
    border-radius: 8px;
    padding: 14px 16px;
    margin-bottom: 16px;
    font-size: 14px;
    color: #1e40af;
    display: none;
  }
  
  .info-banner.show {
    display: block;
  }
  
  #viz {
    width: 100%;
    height: auto;
    display: block;
  }
  
  .legend {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin-top: 16px;
    padding: 12px;
    background: #f9fafb;
    border-radius: 8px;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
  }
  
  .swatch {
    width: 14px;
    height: 14px;
    border-radius: 3px;
    flex-shrink: 0;
  }
  
  .borough-group {
    cursor: pointer;
    transition: opacity 0.15s;
  }
  
  .borough-group:hover .tile-bg {
    stroke: #3b82f6;
    stroke-width: 2.5;
  }
  
  .tooltip {
    position: absolute;
    pointer-events: none;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 6px 24px rgba(0,0,0,0.12);
    padding: 10px 12px;
    font-size: 13px;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 1000;
  }
  
  .tooltip.show {
    opacity: 1;
  }
  
  #detail-panel {
    flex: 0 0 380px;
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    display: none;
    max-height: 640px;
    overflow-y: auto;
  }
  
  #detail-panel.show {
    display: block;
  }
  
  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border);
  }
  
  .panel-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0;
  }
  
  .panel-subtitle {
    font-size: 13px;
    color: var(--muted);
    margin: 4px 0 0 0;
  }
  
  .close-btn {
    background: #f3f4f6;
    border: none;
    border-radius: 6px;
    width: 28px;
    height: 28px;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
  }
  
  .close-btn:hover {
    background: #e5e7eb;
  }
  
  .stat-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .stat-card {
    background: #f9fafb;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
  }
  
  .stat-label {
    font-size: 11px;
    text-transform: uppercase;
    color: var(--muted);
    font-weight: 600;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }
  
  .stat-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--ink);
  }
  
  .stat-unit {
    font-size: 11px;
    font-weight: 400;
    margin-left: 4px;
  }
  
  .breakdown-section {
    margin-bottom: 20px;
  }
  
  .section-title {
    font-size: 14px;
    font-weight: 600;
    margin: 0 0 12px 0;
  }
  
  .breakdown-bar {
    margin-bottom: 10px;
  }
  
  .breakdown-label {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    margin-bottom: 4px;
  }
  
  .breakdown-visual {
    height: 20px;
    background: #f3f4f6;
    border-radius: 4px;
    overflow: hidden;
  }
  
  .breakdown-segment {
    height: 100%;
    float: left;
  }
  
  @media (max-width: 1400px) {
    .main-container.panel-open {
      transform: translateX(-50px);
    }
    #detail-panel {
      flex: 0 0 340px;
    }
  }
  
  @media (max-width: 1200px) {
    .main-container {
      flex-direction: column;
      transform: none !important;
    }
    #viz-container {
      flex: 1 1 auto;
    }
    #detail-panel {
      width: 100%;
      max-width: none;
    }
  }
</style>

<div id="app">
  <header>
    <h1 class="title">NYC Waste Analysis</h1>
    <div class="controls">
      <div class="slider-container">
        <button id="playBtn">▶ Play</button>
        <input type="range" id="timeSlider" min="0" max="0" value="0">
        <span class="month-label" id="monthLabel">—</span>
      </div>
      <label>
        <input type="checkbox" id="breakdownToggle">
        <span>Organics breakdown</span>
      </label>
      <label>
        <input type="checkbox" id="percentToggle">
        <span>Show as %</span>
      </label>
      <label>
        <input type="checkbox" id="excludeRefuseToggle" checked>
        <span>Exclude refuse</span>
      </label>
      <label>
        <input type="checkbox" id="perCapitaToggle">
        <span>Per capita</span>
      </label>
    </div>
  </header>
  
  <div class="main-container">
    <div id="viz-container">
      <div class="info-banner" id="infoBanner">
        <strong>Per Capita:</strong> Tile sizes show lbs/person/month.
      </div>
      <svg id="viz" viewBox="0 0 1100 640"></svg>
      <div class="legend" id="legend"></div>
    </div>
    
    <div id="detail-panel">
      <div class="panel-header">
        <div>
          <h2 class="panel-title" id="panelBorough">—</h2>
          <p class="panel-subtitle" id="panelMonth">—</p>
        </div>
        <button class="close-btn" id="closePanel">×</button>
      </div>
      <div class="stat-grid" id="statGrid"></div>
      <div class="breakdown-section">
        <h3 class="section-title">Composition</h3>
        <div id="compositionBreakdown"></div>
      </div>
    </div>
  </div>
  
  <div class="tooltip" id="tooltip"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
(async function () {
  'use strict';

  // ───────────────────────────────────────────────────────────────
  // BOUNDS: show only April 1993 through Dec 2025, and start at 1993-04
  const START_BOUND = new Date(Date.UTC(1993, 3, 1));   // April 1, 1993 (month index 3)
  const END_BOUND   = new Date(Date.UTC(2025, 11, 31)); // Dec 31, 2025
  // ───────────────────────────────────────────────────────────────

  const COLORS = {
    paper: "#f59e0b",
    mgp: "#8b5cf6",
    all_organics: "#10b981",
    refuse: "#64748b",
    res: "#22c55e",
    school: "#3b82f6",
    leaves: "#eab308",
    xmas: "#ef4444",
    other: "#ec4899"
  };

  const LABELS = {
    paper: "Paper",
    mgp: "Metal/Glass/Plastic",
    all_organics: "All Organics",
    refuse: "Refuse",
    res: "Residential Organics",
    school: "School Organics",
    leaves: "Leaves",
    xmas: "Christmas Trees",
    other: "Other Organics"
  };

  const POPULATION = {
    'Queens': 2211000,
    'Brooklyn': 2559000,
    'Manhattan': 1568000,
    'Bronx': 1362000,
    'Staten Island': 475000
  };

  const state = {
    monthIndex: 0,
    breakdown: false,
    showPercent: false,
    excludeRefuse: true,
    perCapita: false,
    playing: false,
    playInterval: null,
    selectedBorough: null,
    monthsSorted: [],
    dataByMonth: new Map()
  };

  const SVG_WIDTH = 1100;
  const SVG_HEIGHT = 640;

  // ───────────────────────────────────────────────────────────────
  // Utilities
  function parseMonth(str) {
    const m = str.match(/(\d{4})\s*[/\-]\s*(\d{2})/);
    if (!m) return null;
    return new Date(Date.UTC(+m[1], +m[2] - 1, 1));
  }

  function formatMonth(str) {
    const date = parseMonth(str);
    if (!date) return str;
    return `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, '0')}`;
  }

  function formatNumber(n) {
    return new Intl.NumberFormat('en-US').format(Math.round(n));
  }

  function formatPercent(n) {
    return d3.format('.0%')(n);
  }

  function tonsToLbsPerPerson(tons, borough) {
    const pop = POPULATION[borough];
    if (!pop) return 0;
    return (tons * 2000) / pop;
  }

  function formatPerCapita(lbs) {
    return d3.format('.1f')(lbs);
  }
  // ───────────────────────────────────────────────────────────────

  // Data processing
  function processData(rawData) {
    const rows = [];

    for (const d of rawData) {
      const monthStr = (d.MONTH || '').trim();
      const borough = (d.BOROUGH || '').trim();
      if (!monthStr || !borough) continue;

      rows.push({
        monthStr, borough,
        paper: +(d.PAPERTONSCOLLECTED || 0),
        mgp: +(d.MGPTONSCOLLECTED || 0),
        refuse: +(d.REFUSETONSCOLLECTED || 0),
        res: +(d.RESORGANICSTONS || 0),
        school: +(d.SCHOOLORGANICTONS || 0),
        leaves: +(d.LEAVESORGANICTONS || 0),
        xmas: +(d.XMASTREETONS || 0),
        other: +(d.OTHERORGANICSTONS || 0)
      });
    }

    const uniqueMonths = [...new Set(rows.map(r => r.monthStr))];
    const monthsSorted = uniqueMonths
      .map(ms => ({ ms, date: parseMonth(ms) }))
      .filter(d => d.date)
      .sort((a, b) => a.date - b.date)
      .map(d => d.ms);

    const dataByMonth = new Map();

    for (const ms of monthsSorted) {
      const monthData = rows.filter(r => r.monthStr === ms);
      const boroughMap = new Map();

      for (const borough of ['Brooklyn', 'Manhattan', 'Bronx', 'Queens', 'Staten Island']) {
        const boroughRows = monthData.filter(r => r.borough === borough);

        const paper = d3.sum(boroughRows, r => r.paper);
        const mgp = d3.sum(boroughRows, r => r.mgp);
        const refuse = d3.sum(boroughRows, r => r.refuse);
        const res = d3.sum(boroughRows, r => r.res);
        const school = d3.sum(boroughRows, r => r.school);
        const leaves = d3.sum(boroughRows, r => r.leaves);
        const xmas = d3.sum(boroughRows, r => r.xmas);
        const other = d3.sum(boroughRows, r => r.other);
        const all_organics = res + school + leaves + xmas + other;

        boroughMap.set(borough, {
          paper, mgp, refuse, res, school, leaves, xmas, other,
          all_organics,
          total: paper + mgp + refuse + all_organics
        });
      }

      dataByMonth.set(ms, boroughMap);
    }

    return { monthsSorted, dataByMonth };
  }

  // Layout helpers
  function getGridLayout() {
    const pad = 16;
    const cols = 3, rows = 2;
    const cellW = (SVG_WIDTH - pad * (cols + 1)) / cols;
    const cellH = (SVG_HEIGHT - pad * (rows + 1)) / rows;

    return {
      'Brooklyn': { x: pad, y: pad, w: cellW, h: cellH },
      'Manhattan': { x: pad + cellW + pad, y: pad, w: cellW, h: cellH },
      'Bronx': { x: pad + 2 * (cellW + pad), y: pad, w: cellW, h: cellH },
      'Queens': { x: pad, y: pad + cellH + pad, w: cellW, h: cellH },
      'Staten Island': { x: pad + cellW + pad, y: pad + cellH + pad, w: cellW, h: cellH }
    };
  }

  function getStreamKeys() {
    const keys = state.breakdown
      ? ['paper', 'mgp', 'res', 'school', 'leaves', 'xmas', 'other', 'refuse']
      : ['paper', 'mgp', 'all_organics', 'refuse'];

    return state.excludeRefuse ? keys.filter(k => k !== 'refuse') : keys;
  }

  // Rendering
  function render() {
    const monthStr = state.monthsSorted[state.monthIndex];
    const boroughData = state.dataByMonth.get(monthStr);
    if (!boroughData) return;

    const gridLayout = getGridLayout();
    const keys = getStreamKeys();
    const svg = d3.select('#viz');
    const boroughs = ['Brooklyn', 'Manhattan', 'Bronx', 'Queens', 'Staten Island'];

    const totals = state.perCapita
      ? boroughs.map(b => tonsToLbsPerPerson(boroughData.get(b).total, b))
      : boroughs.map(b => boroughData.get(b).total);

    const maxTotal = d3.max(totals) || 1;
    const sizeScale = d3.scaleSqrt().domain([0, maxTotal]).range([0.5, 1]);

    const tiles = boroughs.map(borough => {
      const data = boroughData.get(borough);
      const frame = gridLayout[borough];
      const displayValue = state.perCapita
        ? tonsToLbsPerPerson(data.total, borough)
        : data.total;
      const scale = sizeScale(displayValue);
      const w = frame.w * scale;
      const h = frame.h * scale;

      return {
        borough,
        x: frame.x + (frame.w - w) / 2,
        y: frame.y + (frame.h - h) / 2,
        w: Math.max(100, w),
        h: Math.max(80, h),
        data,
        displayValue
      };
    });

    const groups = svg.selectAll('g.borough-group')
      .data(tiles, d => d.borough);

    const groupsEnter = groups.enter()
      .append('g')
      .attr('class', 'borough-group')
      .on('click', (event, d) => showDetailPanel(d.borough));

    groupsEnter.append('rect').attr('class', 'tile-bg').attr('rx', 10).attr('fill', '#fafafa');
    groupsEnter.append('text').attr('class', 'borough-name').attr('font-weight', 600).attr('font-size', 15);
    groupsEnter.append('text').attr('class', 'total-tons').attr('font-size', 12).attr('fill', '#6b7280');
    groupsEnter.append('g').attr('class', 'segments');

    const groupsMerge = groups.merge(groupsEnter);

    groupsMerge
      .transition().duration(450)
      .attr('transform', d => `translate(${d.x},${d.y})`);

    groupsMerge.select('.tile-bg')
      .transition().duration(450)
      .attr('width', d => d.w)
      .attr('height', d => d.h)
      .attr('stroke', d => state.selectedBorough === d.borough ? '#3b82f6' : '#e5e7eb')
      .attr('stroke-width', d => state.selectedBorough === d.borough ? 3 : 1.5);

    groupsMerge.select('.borough-name')
      .text(d => d.borough)
      .attr('x', 12).attr('y', 20);

    groupsMerge.select('.total-tons')
      .text(d => state.showPercent
        ? '100%'
        : state.perCapita
          ? `${formatPerCapita(d.displayValue)} lbs/person`
          : `${formatNumber(d.data.total)} tons`)
      .attr('x', 12).attr('y', 36);

    groupsMerge.each(function (tile) {
      const segmentGroup = d3.select(this).select('.segments');
      const pad = 16, startY = 50;
      const barW = tile.w - pad * 2;
      const barH = tile.h - startY - pad;

      const values = keys.map(k => ({ key: k, value: tile.data[k] || 0 }));
      const totalValue = d3.sum(values, v => v.value) || 1;

      let y = startY;
      const segments = values.map(v => {
        const h = Math.max(1, barH * (v.value / totalValue));
        const seg = {
          key: v.key,
          value: v.value,
          perCapitaValue: tonsToLbsPerPerson(v.value, tile.borough),
          share: v.value / totalValue,
          x: pad, y, w: barW, h,
          borough: tile.borough
        };
        y += h;
        return seg;
      });

      const rects = segmentGroup.selectAll('rect.segment').data(segments, d => d.key);

      rects.enter().append('rect')
        .attr('class', 'segment')
        .attr('rx', 2)
        .attr('stroke', 'rgba(255,255,255,0.3)')
        .attr('stroke-width', 0.5)
        .style('cursor', 'pointer')
        .on('mouseenter', showTooltip)
        .on('mousemove', moveTooltip)
        .on('mouseleave', hideTooltip)
        .merge(rects)
        .transition().duration(450)
        .attr('x', d => d.x)
        .attr('y', d => d.y)
        .attr('width', d => d.w)
        .attr('height', d => d.h)
        .attr('fill', d => COLORS[d.key]);

      rects.exit().remove();

      const labels = segmentGroup.selectAll('text.segment-label')
        .data(segments.filter(s => s.h > 30 && s.share >= 0.05), d => d.key);

      labels.enter().append('text')
        .attr('class', 'segment-label')
        .attr('text-anchor', 'middle')
        .attr('font-size', 11)
        .attr('font-weight', 600)
        .attr('fill', 'white')
        .style('pointer-events', 'none')
        .merge(labels)
        .text(d => formatPercent(d.share))
        .transition().duration(450)
        .attr('x', d => d.x + d.w / 2)
        .attr('y', d => d.y + d.h / 2 + 4);

      labels.exit().remove();
    });

    groups.exit().remove();
  }

  // Tooltip
  const tooltip = d3.select('#tooltip');

  function showTooltip(event, d) {
    const html = state.perCapita
      ? `<strong>${LABELS[d.key]}</strong><br>${formatPerCapita(d.perCapitaValue)} lbs/person<br>${formatPercent(d.share)} of total`
      : `<strong>${LABELS[d.key]}</strong><br>${formatNumber(d.value)} tons<br>${formatPercent(d.share)} of total`;
    tooltip.html(html).classed('show', true);
    moveTooltip(event);
  }

  function moveTooltip(event) {
    tooltip.style('left', (event.pageX + 12) + 'px').style('top', (event.pageY - 12) + 'px');
  }

  function hideTooltip() {
    tooltip.classed('show', false);
  }

  // Detail Panel
  function showDetailPanel(borough) {
    state.selectedBorough = borough;
    const panel = d3.select('#detail-panel');
    panel.classed('show', true);
    d3.select('.main-container').classed('panel-open', true);

    const monthStr = state.monthsSorted[state.monthIndex];
    const data = state.dataByMonth.get(monthStr).get(borough);

    d3.select('#panelBorough').text(borough);
    d3.select('#panelMonth').text(formatMonth(monthStr));

    const population = POPULATION[borough];
    const totalWaste = data.total;
    const perCapitaWaste = tonsToLbsPerPerson(totalWaste, borough);
    const recyclables = data.paper + data.mgp;
    const diversionRate = (recyclables + data.all_organics) / Math.max(1, totalWaste);

    const stats = [
      { label: 'Total Waste', value: state.perCapita ? formatPerCapita(perCapitaWaste) : formatNumber(totalWaste), unit: state.perCapita ? 'lbs/person' : 'tons' },
      { label: 'Population', value: formatNumber(population), unit: 'people' },
      { label: 'Recyclables', value: formatNumber(recyclables), unit: 'tons' },
      { label: 'Diversion', value: formatPercent(diversionRate), unit: '' }
    ];

    const statGrid = d3.select('#statGrid');
    const cards = statGrid.selectAll('.stat-card').data(stats);
    const cardsEnter = cards.enter().append('div').attr('class', 'stat-card');
    cardsEnter.append('div').attr('class', 'stat-label');
    cardsEnter.append('div').attr('class', 'stat-value');

    const cardsMerge = cards.merge(cardsEnter);
    cardsMerge.select('.stat-label').text(d => d.label);
    cardsMerge.select('.stat-value').html(d => `${d.value}<span class="stat-unit">${d.unit}</span>`);

    const keys = getStreamKeys();
    const breakdown = keys.map(k => ({
      key: k,
      label: LABELS[k],
      value: data[k] || 0,
      color: COLORS[k]
    }));

    const totalForBreakdown = d3.sum(breakdown, d => d.value);

    const breakdownDiv = d3.select('#compositionBreakdown');
    const bars = breakdownDiv.selectAll('.breakdown-bar').data(breakdown);
    const barsEnter = bars.enter().append('div').attr('class', 'breakdown-bar');
    barsEnter.append('div').attr('class', 'breakdown-label');
    barsEnter.append('div').attr('class', 'breakdown-visual');

    const barsMerge = bars.merge(barsEnter);
    barsMerge.select('.breakdown-label').html(d => `<span>${d.label}</span><span style="color:#6b7280">${formatNumber(d.value)} tons</span>`);
    barsMerge.select('.breakdown-visual').html(d => `<div class="breakdown-segment" style="width:${100 * d.value / totalForBreakdown}%; background:${d.color}"></div>`);

    bars.exit().remove();
    render();
  }

  function closeDetailPanel() {
    d3.select('#detail-panel').classed('show', false);
    d3.select('.main-container').classed('panel-open', false);
    state.selectedBorough = null;
    render();
  }

  // Month update & controls
  function updateMonth(index) {
    state.monthIndex = Math.max(0, Math.min(state.monthsSorted.length - 1, index));
    d3.select('#timeSlider').property('value', state.monthIndex);
    d3.select('#monthLabel').text(formatMonth(state.monthsSorted[state.monthIndex]));
    render();
    if (state.selectedBorough) showDetailPanel(state.selectedBorough);
  }

  function togglePlay() {
    state.playing = !state.playing;
    const btn = d3.select('#playBtn');

    if (state.playing) {
      btn.text('⏸ Pause');
      state.playInterval = setInterval(() => {
        const next = state.monthIndex + 1;
        updateMonth(next >= state.monthsSorted.length ? 0 : next);
      }, 500);
    } else {
      btn.text('▶ Play');
      if (state.playInterval) clearInterval(state.playInterval);
    }
  }

  function updateLegend() {
    const keys = getStreamKeys();
    const legend = d3.select('#legend');
    const items = legend.selectAll('.legend-item').data(keys, d => d);
    const enter = items.enter().append('div').attr('class', 'legend-item');
    enter.append('div').attr('class', 'swatch');
    enter.append('span');
    const merge = items.merge(enter);
    merge.select('.swatch').style('background', k => COLORS[k]);
    merge.select('span').text(k => LABELS[k]);
    items.exit().remove();
  }

  // INIT
  async function init() {
    try {
      const rawData = await d3.csv('data/dsny.csv');
      const { monthsSorted, dataByMonth } = processData(rawData);

      // ── Clamp months to [1993-04, 2025-12]
      const clamped = monthsSorted.filter(ms => {
        const d = parseMonth(ms);
        return d && d >= START_BOUND && d <= END_BOUND;
      });

      state.monthsSorted = clamped.length ? clamped : monthsSorted; // fallback if no match
      state.dataByMonth = dataByMonth;

      // Controls
      d3.select('#timeSlider')
        .property('max', state.monthsSorted.length - 1)
        .on('input', function () { updateMonth(+this.value); });

      d3.select('#playBtn').on('click', togglePlay);
      d3.select('#breakdownToggle').on('change', function () { state.breakdown = this.checked; updateLegend(); render(); if (state.selectedBorough) showDetailPanel(state.selectedBorough); });
      d3.select('#percentToggle').on('change', function () { state.showPercent = this.checked; render(); });
      d3.select('#excludeRefuseToggle').on('change', function () { state.excludeRefuse = this.checked; updateLegend(); render(); if (state.selectedBorough) showDetailPanel(state.selectedBorough); });
      d3.select('#perCapitaToggle').on('change', function () {
        state.perCapita = this.checked;
        d3.select('#infoBanner').classed('show', this.checked);
        render();
        if (state.selectedBorough) showDetailPanel(state.selectedBorough);
      });
      d3.select('#closePanel').on('click', closeDetailPanel);

      document.addEventListener('keydown', e => {
        if (e.target.tagName === 'INPUT') return;
        if (e.key === 'ArrowLeft') { e.preventDefault(); updateMonth(state.monthIndex - 1); }
        if (e.key === 'ArrowRight') { e.preventDefault(); updateMonth(state.monthIndex + 1); }
        if (e.key === ' ') { e.preventDefault(); togglePlay(); }
        if (e.key === 'Escape') { closeDetailPanel(); }
      });

      updateLegend();

      // ── Start at April 1993 if present; else start at first clamped month
      const startIdx = state.monthsSorted.findIndex(ms => {
        const d = parseMonth(ms);
        return d && d.getUTCFullYear() === 1993 && d.getUTCMonth() === 3; // April
      });
      updateMonth(startIdx >= 0 ? startIdx : 0);

    } catch (error) {
      console.error('Error:', error);
      d3.select('#viz-container').html('<p style="color:red">Error loading data. Check console.</p>');
    }
  }

  init();

})();
</script>

</html>
